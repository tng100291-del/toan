<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Math Arena - Keyboard Version</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1e1e2e; font-family: 'Segoe UI', sans-serif; color: white; user-select: none; }
        
        /* GIAO DI·ªÜN GAME */
        #game-area { position: relative; width: 100vw; height: 100vh; display: none; }
        
        #input-area {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 300px; padding: 15px; font-size: 30px; text-align: center; font-weight: bold;
            background: rgba(0, 0, 0, 0.6); color: #fff;
            border: 3px solid #00ff99; border-radius: 50px; outline: none;
            box-shadow: 0 0 20px rgba(0, 255, 153, 0.3); transition: border 0.1s, transform 0.1s;
        }

        .falling-item {
            position: absolute; color: #fff; font-size: 36px; font-weight: bold;
            padding: 10px 20px; border-radius: 15px;
            background: rgba(255, 255, 255, 0.15);
            text-shadow: 0 0 5px #000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            white-space: nowrap; z-index: 5;
        }

        /* UI TR√äN C√ôNG */
        #ui-board {
            position: absolute; top: 15px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 24px; z-index: 10;
        }
        .stat-box { 
            background: rgba(0,0,0,0.6); padding: 10px 25px; 
            border-radius: 12px; border: 1px solid #555; 
            backdrop-filter: blur(5px); display: flex; align-items: center; gap: 15px;
        }

        /* M√ÄN H√åNH START */
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.94);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20;
        }
        h1 { font-size: 70px; color: #00ff99; margin: 0; text-shadow: 0 0 30px #00ff99; text-transform: uppercase; }
        p { font-size: 18px; color: #aaa; margin-bottom: 30px; margin-top: 10px;}

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 20px; border: 1px solid #444; }
        .control-group { text-align: center; }
        label { font-size: 18px; display: block; margin-bottom: 10px; color: #ff00de; font-weight: bold; }
        input[type="number"], select { padding: 12px; font-size: 18px; width: 150px; text-align: center; border-radius: 8px; border: 2px solid #555; outline: none; background: #222; color: white; }
        button.btn-start { padding: 15px 60px; font-size: 26px; font-weight: bold; background: linear-gradient(45deg, #ff00de, #00ff99); border: none; border-radius: 50px; cursor: pointer; color: #fff; box-shadow: 0 0 20px rgba(0, 255, 153, 0.4); }

        /* FX */
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 25% { transform: translate(-3px, 0px); } 50% { transform: translate(3px, 0px); } 75% { transform: translate(-1px, 2px); } 100% { transform: translate(0px, 0px); } }
        .red-flash { animation: flashRed 0.3s; }
        @keyframes flashRed { 0% { background-color: rgba(255, 0, 0, 0.4); } 100% { background-color: transparent; } }

    </style>
</head>
<body>

    <div id="start-screen" class="overlay-screen">
        <h1>Math Arena</h1>
        <p>Phi√™n b·∫£n Luy·ªán G√µ Ph√≠m & T√≠nh Nhanh</p>
        
        <div class="settings-grid">
            <div class="control-group">
                <label>‚ù§Ô∏è S·ªë m·∫°ng:</label>
                <input type="number" id="lives-input" value="5" min="1" max="99">
            </div>
            <div class="control-group">
                <label>üöÄ T·ªëc ƒë·ªô:</label>
                <select id="speed-input">
                    <option value="1">1. T·∫≠p s·ª± (Ch·∫≠m)</option>
                    <option value="2" selected>2. H·ªçc sinh (V·ª´a)</option>
                    <option value="3">3. Gi√°o s∆∞ (Nhanh)</option>
                    <option value="4">4. Si√™u m√°y t√≠nh</option>
                </select>
            </div>
        </div>
        <button class="btn-start" onclick="startGame()">V√ÄO GAME</button>
    </div>

    <div id="game-over-screen" class="overlay-screen" style="display: none;">
        <h1 style="color: #ff4444;">GAME OVER</h1>
        <p id="final-score" style="font-size: 30px; color: white;">ƒêi·ªÉm s·ªë: 0</p>
        <p id="level-info" style="font-size: 18px; color: #aaa;"></p>
        <button class="btn-start" onclick="location.reload()">CH∆†I L·∫†I</button>
    </div>

    <div id="game-area">
        <div id="ui-board">
            <div class="stat-box">
                <span id="score-display" style="font-weight: bold;">‚≠ê ƒêi·ªÉm: 0</span>
            </div>
            <div class="stat-box" id="lives-display" style="color: #ff6666; font-weight:bold;">‚ù§Ô∏è 5</div>
        </div>

        <input type="number" id="input-area" placeholder="Nh·∫≠p s·ªë & Enter..." autocomplete="off">
    </div>

<script>
    // --- KHAI B√ÅO BI·∫æN ---
    const gameArea = document.getElementById('game-area');
    const inputArea = document.getElementById('input-area');
    const scoreDisplay = document.getElementById('score-display');
    const livesDisplay = document.getElementById('lives-display');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');

    let score = 0;
    let lives = 5;
    let isPlaying = false;
    let fallingSpeed = 1; 
    let spawnRate = 2000; 
    let speedIncreaseRate = 0.0005;

    let items = [];
    let animationFrameId;
    let spawnTimeoutId;

    const DIFFICULTY_SETTINGS = {
        1: { speed: 1.0, spawn: 2800 },
        2: { speed: 1.8, spawn: 2200 },
        3: { speed: 3.0, spawn: 1400 },
        4: { speed: 5.0, spawn: 900 }
    };

    // --- GAME LOGIC ---
    function startGame() {
        let userLives = parseInt(document.getElementById('lives-input').value) || 5;
        lives = userLives;
        let speedLevel = parseInt(document.getElementById('speed-input').value);
        let setting = DIFFICULTY_SETTINGS[speedLevel];
        
        fallingSpeed = setting.speed;
        spawnRate = setting.spawn;
        score = 0; items = [];
        
        startScreen.style.display = 'none';
        gameArea.style.display = 'block';
        updateUI();
        inputArea.value = '';
        inputArea.focus();
        
        isPlaying = true;
        createProblem();
        updateGameLoop();
    }

    function createProblem() {
        if (!isPlaying) return;
        
        // Logic t·∫°o ƒë·ªô kh√≥ tƒÉng d·∫ßn
        let range = 10 + Math.floor(score / 50) * 5; 
        let a = Math.floor(Math.random() * range) + 1;
        let b = Math.floor(Math.random() * range) + 1;
        let ops = ['+', '-'];
        if (score > 100) ops.push('x');
        
        let operator = ops[Math.floor(Math.random() * ops.length)];
        let result;
        if (operator === '-') { if (a < b) [a, b] = [b, a]; result = a - b; }
        else if (operator === 'x') { a = Math.floor(Math.random()*10)+1; b = Math.floor(Math.random()*10); result = a * b; }
        else { result = a + b; }

        const problem = {
            id: Date.now() + Math.random(),
            text: `${a} ${operator} ${b}`,
            result: result,
            x: Math.random() * (window.innerWidth - 180) + 50,
            y: -80,
            element: null
        };

        const el = document.createElement('div');
        el.classList.add('falling-item');
        el.innerText = problem.text;
        el.style.left = problem.x + 'px';
        
        // M√†u s·∫Øc ng·∫´u nhi√™n neon
        let hue = Math.floor(Math.random() * 360);
        el.style.border = `3px solid hsl(${hue}, 100%, 60%)`;
        el.style.color = `hsl(${hue}, 100%, 80%)`;

        gameArea.appendChild(el);
        problem.element = el;
        items.push(problem);

        spawnTimeoutId = setTimeout(createProblem, spawnRate);
        if (spawnRate > 600) spawnRate -= 10; 
    }

    function updateGameLoop() {
        if (!isPlaying) return;
        items.forEach((item, index) => {
            item.y += fallingSpeed;
            item.element.style.top = item.y + 'px';
            if (item.y > window.innerHeight - 80) {
                item.element.remove();
                items.splice(index, 1);
                loseLife();
            }
        });
        fallingSpeed += speedIncreaseRate;
        animationFrameId = requestAnimationFrame(updateGameLoop);
    }

    function checkAnswer(val) {
        let foundIdx = -1;
        let lowestY = -1000;

        // T√¨m ph√©p t√≠nh th·∫•p nh·∫•t kh·ªõp k·∫øt qu·∫£
        items.forEach((item, index) => {
            if (item.result === val) {
                if (item.y > lowestY) { lowestY = item.y; foundIdx = index; }
            }
        });

        if (foundIdx !== -1) {
            // ƒê√öNG
            const item = items[foundIdx];
            item.element.style.transform = "scale(2)";
            item.element.style.opacity = "0";
            item.element.innerHTML = "üí•"; 
            setTimeout(() => item.element.remove(), 200);
            
            items.splice(foundIdx, 1);
            score += 10;
            
            inputArea.style.borderColor = "#00ff99";
            inputArea.style.transform = "translateX(-50%) scale(1.1)";
            setTimeout(() => {
                inputArea.value = ''; 
                inputArea.style.transform = "translateX(-50%) scale(1)";
            }, 100);

        } else {
            // SAI
            inputArea.style.borderColor = "#ff4444";
            gameArea.classList.add('shake');
            setTimeout(() => {
                inputArea.style.borderColor = "#00ff99";
                gameArea.classList.remove('shake');
            }, 300);
            inputArea.value = ''; // X√≥a ƒëi cho nh·∫≠p l·∫°i
        }
        updateUI();
    }

    function loseLife() {
        lives--;
        updateUI();
        gameArea.classList.add('red-flash');
        setTimeout(() => gameArea.classList.remove('red-flash'), 500);
        if (lives <= 0) endGame();
    }

    // X·ª≠ l√Ω ph√≠m Enter
    inputArea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const val = parseInt(inputArea.value);
            if (!isNaN(val)) checkAnswer(val);
            else inputArea.value = '';
        }
    });

    function endGame() {
        isPlaying = false;
        clearTimeout(spawnTimeoutId);
        cancelAnimationFrame(animationFrameId);
        
        items.forEach(i => i.element.remove());
        items = [];
        gameArea.style.display = 'none';
        gameOverScreen.style.display = 'flex';
        document.getElementById('final-score').innerText = "ƒêi·ªÉm s·ªë: " + score;
        
        let msg = score < 50 ? "C·∫ßn c·ªë g·∫Øng h∆°n! üí™" : (score < 200 ? "Kh√° l·∫Øm! üëç" : "Tuy·ªát v·ªùi! üèÜ");
        document.getElementById('level-info').innerText = msg;
    }

    function updateUI() {
        scoreDisplay.innerText = "‚≠ê ƒêi·ªÉm: " + score;
        livesDisplay.innerText = "‚ù§Ô∏è M·∫°ng: " + lives;
    }
    
    // Auto focus ƒë·ªÉ lu√¥n nh·∫≠p ƒë∆∞·ª£c
    document.addEventListener('click', () => { if(isPlaying) inputArea.focus(); });

</script>
</body>
</html>